/*
 * Copyright 2019-2021 Mamoe Technologies and contributors.
 *
 * 此源代码的使用受 GNU AFFERO GENERAL PUBLIC LICENSE version 3 许可证的约束, 可以在以下链接找到该许可证.
 * Use of this source code is governed by the GNU AGPLv3 license that can be found through the following link.
 *
 * https://github.com/mamoe/mirai/blob/dev/LICENSE
 */

package net.mamoe.mirai.utils

import java.io.DataInputStream

private val DATA
    get() = """
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
A8cABiYjOTY3OwPHAAUmY2hpOwPHAAcmI3gzQzg7A8gABiYjOTY4OwPIAAUmcHNpOwPIAAcmI3gz
Qzk7A8kABiYjOTY5OwPJAAcmb21lZ2E7A8kAByYjeDNEMTsD0QAGJiM5Nzc7A9EACiZ0aGV0YXN5
bTsD0QAHJiN4M0QyOwPSAAYmIzk3ODsD0gAHJnVwc2loOwPSAAcmI3gzRDY7A9YABiYjOTgyOwPW
AAUmcGl2OwPWAAgmI3gyMDIyOyAiAAcmIzgyMjY7ICIABiZidWxsOyAiAAgmI3gyMDI2OyAmAAcm
IzgyMzA7ICYACCZoZWxsaXA7ICYACCYjeDIwMzI7IDIAByYjODI0MjsgMgAHJnByaW1lOyAyAAgm
I3gyMDMzOyAzAAcmIzgyNDM7IDMAByZQcmltZTsgMwAIJiN4MjAzRTsgPgAHJiM4MjU0OyA+AAcm
b2xpbmU7ID4ACCYjeDIwNDQ7IEQAByYjODI2MDsgRAAHJmZyYXNsOyBEAAgmI3gyMTE4OyEYAAcm
Izg0NzI7IRgACCZ3ZWllcnA7IRgACCYjeDIxMTE7IREAByYjODQ2NTshEQAHJmltYWdlOyERAAgm
I3gyMTFDOyEcAAcmIzg0NzY7IRwABiZyZWFsOyEcAAgmI3gyMTIyOyEiAAcmIzg0ODI7ISIAByZ0
cmFkZTshIgAIJiN4MjEzNTshNQAHJiM4NTAxOyE1AAkmYWxlZnN5bTshNQAIJiN4MjE5MDshkAAH
JiM4NTkyOyGQAAYmbGFycjshkAAIJiN4MjE5MTshkQAHJiM4NTkzOyGRAAYmdWFycjshkQAIJiN4
MjE5MjshkgAHJiM4NTk0OyGSAAYmcmFycjshkgAIJiN4MjE5MzshkwAHJiM4NTk1OyGTAAYmZGFy
cjshkwAIJiN4MjE5NDshlAAHJiM4NTk2OyGUAAYmaGFycjshlAAIJiN4MjFCNTshtQAHJiM4NjI5
OyG1AAcmY3JhcnI7IbUACCYjeDIxRDA7IdAAByYjODY1Njsh0AAGJmxBcnI7IdAACCYjeDIxRDE7
IdEAByYjODY1Nzsh0QAGJnVBcnI7IdEACCYjeDIxRDI7IdIAByYjODY1ODsh0gAGJnJBcnI7IdIA
CCYjeDIxRDM7IdMAByYjODY1OTsh0wAGJmRBcnI7IdMACCYjeDIxRDQ7IdQAByYjODY2MDsh1AAG
JmhBcnI7IdQACCYjeDIyMDA7IgAAByYjODcwNDsiAAAIJmZvcmFsbDsiAAAIJiN4MjIwMjsiAgAH
JiM4NzA2OyICAAYmcGFydDsiAgAIJiN4MjIwMzsiAwAHJiM4NzA3OyIDAAcmZXhpc3Q7IgMACCYj
eDIyMDU7IgUAByYjODcwOTsiBQAHJmVtcHR5OyIFAAgmI3gyMjA3OyIHAAcmIzg3MTE7IgcAByZu
YWJsYTsiBwAIJiN4MjIwODsiCAAHJiM4NzEyOyIIAAYmaXNpbjsiCAAIJiN4MjIwOTsiCQAHJiM4
NzEzOyIJAAcmbm90aW47IgkACCYjeDIyMEI7IgsAByYjODcxNTsiCwAEJm5pOyILAAgmI3gyMjBG
OyIPAAcmIzg3MTk7Ig8ABiZwcm9kOyIPAAgmI3gyMjExOyIRAAcmIzg3MjE7IhEABSZzdW07IhEA
CCYjeDIyMTI7IhIAByYjODcyMjsiEgAHJm1pbnVzOyISAAgmI3gyMjE3OyIXAAcmIzg3Mjc7IhcA
CCZsb3dhc3Q7IhcACCYjeDIyMUE7IhoAByYjODczMDsiGgAHJnJhZGljOyIaAAgmI3gyMjFEOyId
AAcmIzg3MzM7Ih0ABiZwcm9wOyIdAAgmI3gyMjFFOyIeAAcmIzg3MzQ7Ih4AByZpbmZpbjsiHgAI
JiN4MjIyMDsiIAAHJiM4NzM2OyIgAAUmYW5nOyIgAAgmI3gyMjI3OyInAAcmIzg3NDM7IicABSZh
bmQ7IicACCYjeDIyMjg7IigAByYjODc0NDsiKAAEJm9yOyIoAAgmI3gyMjI5OyIpAAcmIzg3NDU7
IikABSZjYXA7IikACCYjeDIyMkE7IioAByYjODc0NjsiKgAFJmN1cDsiKgAIJiN4MjIyQjsiKwAH
JiM4NzQ3OyIrAAUmaW50OyIrAAgmI3gyMjM0OyI0AAcmIzg3NTY7IjQACCZ0aGVyZTQ7IjQACCYj
eDIyM0M7IjwAByYjODc2NDsiPAAFJnNpbTsiPAAIJiN4MjI0NTsiRQAHJiM4NzczOyJFAAYmY29u
ZzsiRQAIJiN4MjI0ODsiSAAHJiM4Nzc2OyJIAAcmYXN5bXA7IkgACCYjeDIyNjA7ImAAByYjODgw
MDsiYAAEJm5lOyJgAAgmI3gyMjYxOyJhAAcmIzg4MDE7ImEAByZlcXVpdjsiYQAIJiN4MjI2NDsi
ZAAHJiM4ODA0OyJkAAQmbGU7ImQACCYjeDIyNjU7ImUAByYjODgwNTsiZQAEJmdlOyJlAAgmI3gy
MjgyOyKCAAcmIzg4MzQ7IoIABSZzdWI7IoIACCYjeDIyODM7IoMAByYjODgzNTsigwAFJnN1cDsi
gwAIJiN4MjI4NDsihAAHJiM4ODM2OyKEAAYmbnN1YjsihAAIJiN4MjI4NjsihgAHJiM4ODM4OyKG
AAYmc3ViZTsihgAIJiN4MjI4NzsihwAHJiM4ODM5OyKHAAYmc3VwZTsihwAIJiN4MjI5NTsilQAH
JiM4ODUzOyKVAAcmb3BsdXM7IpUACCYjeDIyOTc7IpcAByYjODg1NTsilwAIJm90aW1lczsilwAI
JiN4MjJBNTsipQAHJiM4ODY5OyKlAAYmcGVycDsipQAIJiN4MjJDNTsixQAHJiM4OTAxOyLFAAYm
c2RvdDsixQAIJiN4MjMwODsjCAAHJiM4OTY4OyMIAAcmbGNlaWw7IwgACCYjeDIzMDk7IwkAByYj
ODk2OTsjCQAHJnJjZWlsOyMJAAgmI3gyMzBBOyMKAAcmIzg5NzA7IwoACCZsZmxvb3I7IwoACCYj
eDIzMEI7IwsAByYjODk3MTsjCwAIJnJmbG9vcjsjCwAIJiN4MjMyOTsjKQAHJiM5MDAxOyMpAAYm
bGFuZzsjKQAIJiN4MjMyQTsjKgAHJiM5MDAyOyMqAAYmcmFuZzsjKgAIJiN4MjVDQTslygAHJiM5
Njc0OyXKAAUmbG96OyXKAAgmI3gyNjYwOyZgAAcmIzk4MjQ7JmAACCZzcGFkZXM7JmAACCYjeDI2
NjM7JmMAByYjOTgyNzsmYwAHJmNsdWJzOyZjAAgmI3gyNjY1OyZlAAcmIzk4Mjk7JmUACCZoZWFy
dHM7JmUACCYjeDI2NjY7JmYAByYjOTgzMDsmZgAHJmRpYW1zOyZm
""".replace("\r", "")
        .replace("\n", "")
        .replace(" ", "")
        .trim()
        .decodeBase64()

private object HtmlEntityInitializer {
    @JvmField
    val str_to_char: Map<String, String>

    init {
        val reader = DataInputStream(DATA.inputStream())
        val size = reader.readInt()
        str_to_char = HashMap(size)
        repeat(size) {
            str_to_char[reader.readUTF()] = reader.readChar().toString()
        }
    }
}

private inline val STR_TO_CHAR_MAPPINGS get() = HtmlEntityInitializer.str_to_char

@Suppress("RegExpRedundantEscape")
private val STR_TO_CHAR_PATTERN = """\&(\#?[A-Za-z0-9]+?)\;""".toRegex()

public fun String.decodeHtmlEscape(): String = replace(STR_TO_CHAR_PATTERN) { match ->
    STR_TO_CHAR_MAPPINGS[match.value]?.let { return@replace it }
    val match1 = match.groups[1]!!.value
    if (match1.length > 1 && match1[0] == '#') {
        if (match1.length > 2) {
            if (match1[1] == 'x') { // hex
                match1.substring(2).toIntOrNull(16)?.let {
                    return@replace it.toChar().toString()
                }
            }
        }
        match1.substring(1).toIntOrNull()?.let {
            return@replace it.toChar().toString()
        }
    }

    match.value
}

